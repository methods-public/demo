#
#  Dynamically generated by Chef on <%= node["fqdn"] %>
#  Local modifications will be overwritten by Chef.
#
<VirtualHost *:<%= node['confluence']['apache2']['port'] %>>
	<% unless confluence_virtual_host_name.nil? || confluence_virtual_host_name.empty? -%>
	ServerName <%= confluence_virtual_host_name %>
	<% end -%>
	<% unless confluence_virtual_host_alias.empty? -%>
	<% Array(confluence_virtual_host_alias).each do |virtual_host_alias| -%>
	ServerAlias <%= virtual_host_alias %>
	<% end -%>
	<% end -%>
	DocumentRoot <%= node['confluence']['install_path'] %>

	CustomLog <%= node['confluence']['apache2']['access_log'].empty? ? node['apache']['log_dir']+"/confluence-access.log" : node['confluence']['apache2']['access_log'] %> combined
	ErrorLog <%= node['confluence']['apache2']['error_log'].empty? ? node['apache']['log_dir']+"/confluence-error.log" : node['confluence']['apache2']['error_log'] %>
	LogLevel warn

	RewriteEngine On
	RewriteCond %{HTTPS} off
	RewriteCond %{REQUEST_URI} !^/server-status
	RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI}
</VirtualHost>

<VirtualHost *:<%= node['confluence']['apache2']['ssl']['port'] %>>
	<% unless confluence_virtual_host_name.nil? || confluence_virtual_host_name.empty? -%>
	ServerName <%= confluence_virtual_host_name %>
	<% end -%>
	<% unless confluence_virtual_host_alias.empty? -%>
	<% Array(confluence_virtual_host_alias).each do |virtual_host_alias| -%>
	ServerAlias <%= virtual_host_alias %>
	<% end -%>
	<% end -%>
	DocumentRoot <%= node['confluence']['install_path'] %>

	CustomLog <%= node['confluence']['apache2']['ssl']['access_log'].empty? ? node['apache']['log_dir']+"/confluence-ssl-access.log" : node['confluence']['apache2']['ssl']['access_log'] %> combined
	ErrorLog <%= node['confluence']['apache2']['ssl']['error_log'].empty? ? node['apache']['log_dir']+"/confluence-ssl-error.log" : node['confluence']['apache2']['ssl']['error_log'] %>
	LogLevel warn

	<Proxy *>
	<% if node['apache']['version'].to_f < 2.4 -%>
		Order Deny,Allow
		Allow from all
	<% else -%>
		Require all granted
	<% end -%>
	</Proxy>

	<% if node['confluence']['version'].to_f >= 6.0 -%>
	ProxyPass /synchrony http://localhost:8091/synchrony

	<Location /synchrony>
		<% if node['apache']['version'].to_f < 2.4 -%>
		Order Deny,Allow
		Allow from all
		<% else -%>
		Require all granted
		<% end -%>
		RewriteEngine on
		RewriteCond %{HTTP:UPGRADE} ^WebSocket$ [NC]
		RewriteCond %{HTTP:CONNECTION} Upgrade$ [NC]
		RewriteRule .* ws://%{HTTP_HOST}:8091%{REQUEST_URI} [P]
	</Location>
	<% end -%>

	ProxyPass        / http://localhost:<%= node['confluence']['tomcat']['port'] %>/ connectiontimeout=5 timeout=300
	ProxyPassReverse / http://localhost:<%= node['confluence']['tomcat']['port'] %>/

	<Location />
	<% if node['apache']['version'].to_f < 2.4 -%>
		Order Deny,Allow
		Allow from all
	<% else -%>
		Require all granted
	<% end -%>
	</Location>

	SSLEngine on
	SSLCertificateFile <%= node['confluence']['apache2']['ssl']['certificate_file'] %>
	SSLCertificateKeyFile <%= node['confluence']['apache2']['ssl']['key_file'] %>
	<% unless node['confluence']['apache2']['ssl']['chain_file'].empty? -%>
	SSLCertificateChainFile <%= node['confluence']['apache2']['ssl']['chain_file'] %>
	<% end -%>
</VirtualHost>
